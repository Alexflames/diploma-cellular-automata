\documentclass[bachelor, och, autoref, times]{SCWorks}
% параметр - тип обучения - одно из значений:
%    spec     - специальность
%    bachelor - бакалавриат (по умолчанию)
%    master   - магистратура
% параметр - форма обучения - одно из значений:
%    och   - очное (по умолчанию)
%    zaoch - заочное
% параметр - тип работы - одно из значений:
%    referat    - реферат
%    coursework - курсовая работа (по умолчанию)
%    diploma    - дипломная работа
%    pract      - отчет по практике
%    pract      - отчет о научно-исследовательской работе
%    autoref    - автореферат выпускной работы
%    assignment - задание на выпускную квалификационную работу
%    review     - отзыв руководителя
%    critique   - рецензия на выпускную работу
% параметр - включение шрифта
%    times    - включение шрифта Times New Roman (если установлен)
%               по умолчанию выключен
\usepackage[T2A]{fontenc}
\usepackage[cp1251]{inputenc}
\usepackage{graphicx}

\usepackage[sort,compress]{cite}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{fancyvrb}
\usepackage{minted}
\usepackage{longtable}
\usepackage{array}
\usepackage{xcolor}
\usepackage{listings}
\usepackage[english,russian]{babel}

\usepackage[colorlinks=true]{hyperref}

\lstset{%
  language=[Sharp]C,
  basicstyle=\small,
  tabsize = 2,
  breaklines=true,
  columns=fullflexible
}

\newcommand{\eqdef}{\stackrel {\rm def}{=}}

\newtheorem{lem}{Лемма}

\begin{document}

% Кафедра (в родительном падеже)
\chair{математической кибернетики и компьютерных наук}

% Тема работы
\title{Оптимизации поиска приближенных решений в эволюционирующих клеточных автоматах}

% Курс
\course{4}

% Группа
\group{451}

% Факультет (в родительном падеже) (по умолчанию "факультета КНиИТ")
%\department{факультета КНиИТ}

% Специальность/направление код - наименование
%\napravlenie{02.03.02 "--- Фундаментальная информатика и информационные технологии}
%\napravlenie{02.03.01 "--- Математическое обеспечение и администрирование информационных систем}
%\napravlenie{09.03.01 "--- Информатика и вычислительная техника}
\napravlenie{09.03.04 "--- Программная инженерия}
%\napravlenie{10.05.01 "--- Компьютерная безопасность}

% Для студентки. Для работы студента следующая команда не нужна.
%\studenttitle{Студентки}

% Фамилия, имя, отчество в родительном падеже
\author{Григорьева Алексея Александровича}

% Заведующий кафедрой
\chtitle{к.\,ф.-м.\,н., доцент} % степень, звание
\chname{А.\,С.\,Иванов}

%Научный руководитель (для реферата преподаватель проверяющий работу)
\satitle{доцент} %должность, степень, звание
\saname{М.\,С.\,Семенов}

% Руководитель практики от организации (только для практики,
% для остальных типов работ не используется)
\patitle{доцент}
\paname{М.\,С.\,Семенов}

% Семестр (только для практики, для остальных
% типов работ не используется)
\term{8}

% Наименование практики (только для практики, для остальных
% типов работ не используется)
\practtype{преддипломная}

% Продолжительность практики (количество недель) (только для практики,
% для остальных типов работ не используется)
\duration{4}

% Даты начала и окончания практики (только для практики, для остальных
% типов работ не используется)
\practStart{30.04.2020}
\practFinish{27.05.2020}

% Год выполнения отчета
\date{2020}

\maketitle

% Включение нумерации рисунков, формул и таблиц по разделам
% (по умолчанию - нумерация сквозная)
% (допускается оба вида нумерации)
%\secNumbering


\tableofcontents

% Раздел "Обозначения и сокращения". Может отсутствовать в работе
%\abbreviations
%\begin{description}
    %\item \foreignlanguage{english}{EVM} "--- %\foreignlanguage{english}{Ethereum Virtual Machine};
%\end{description}

% Раздел "Определения". Может отсутствовать в работе
%\definitions
%Паттерн "--- целевое изображение, воспроизведение которого должно быть достигнуто клеточным автоматом.

%Эксперимент (в контексте данной работы) "--- процесс поэтапной эволюции клеточных автоматов с целью достижения максимального совпадения воспроизводимых ими результатов заданным наперед паттернам.

%Сетка "--- двумерная регулярная решетка ячеек.


% Раздел "Определения, обозначения и сокращения". Может отсутствовать в работе.
% Если присутствует, то заменяет собой разделы "Обозначения и сокращения" и "Определения"
%\defabbr


% Раздел "Введение"
\intro
Клеточный автомат "--- дискретная модель, изучаемая теорией автоматов~\cite{automata}. В общем случае, клеточный автомат состоит из регулярной решетки ячеек, множества состояний, множества входных сигналов и функции перехода. Клеточные автоматы применяются в компьютерном зрении~\cite{edge-detection}, криптографии~\cite{crypto}, компьютерной графике\cite{cgraphics} и при моделировании различных процессов: физических~\cite{physics}, химических~\cite{chemistry}, биологических~\cite{bio}. Одним из наиболее известных является клеточный автомат "--- игра <<Жизнь>>~\cite{conways}.

Существует огромное количество конфигураций клеточных автоматов. Меняя число возможных состояний, правила подсчета входных сигналов, возможные начальные состояния, получаются новые множества автоматов, перебор которых невозможен с текущими вычислительными мощностями. Поэтому для поиска клеточных автоматов, удовлетворяющих каким-либо условиям, используют алгоритмы нахождения приближенного результата. В недавних работах на схожую тему применялись генетические алгоритмы~\cite{genetic-first} и нейронные сети~\cite{mordvintsev2020growing}.
В выпускной квалификационной работе перебор осуществляется с использованием генетических алгоритмов. 

В основе бакалаврской работы лежит выполнение экспериментов по нахождению приближенного решения клеточными автоматами.
Цель каждого эксперимента "--- стабильное выполнение заданных условий ячейками, полученными после работы клеточных автоматов из множества начальных состояний. Начальное состояние задано случайно в каждой ячейке автомата.
Для наглядности в качестве цели, которая будет поставлена перед началом экспериментов, будет воспроизведение заданного наперед целевого изображения (паттерна). Благодаря этому можно будет не только полагаться на полученные числовые значения, но и сопоставить результат с визуализацией в приложении. После каждого эксперимента должна сохраняться исчерпывающая информация о поведении клеточного автомата. По ней должно быть возможно определить конфигурацию автомата, генетического алгоритма, был ли удачным эксперимент и сколько было затрачено времени.

Эксперименты по оптимизации были проведены для двумерных клеточных автоматов первого порядка, с возможными состояниями 0 и 1. Следующее состояние ячейки клеточного автомата определяется 9 соседними ячейками на решетке включая данную или, другими словами, окрестностью Мура порядка 2~\cite{moore}. 
Тип автоматов выбран не случайно: количество всевозможных правил равно $2^{512}$~\cite{twodimensional},
что гарантирует невозможность перебора. %ссылка на переборы?, лол
Более того, не существует и общего аналитического решения для воспроизведения автоматами произвольного изображения, при условии что изначальная двумерная сетка задана случайными значениями.
У выбранных типов клеточных автоматов также есть преимущества, связанные с возможностью оптимизации алгоритмов с использованием быстрых побитовых операций~\cite{bithacks-perf}. %слегка косяк ибо следующее предложение немного не связано с этим, но намекает собой на это
Многие из описанных далее результатов возможно перенести на случай клеточных автоматов \verb|N|-го порядка~\cite{higherorder}, % так ли это? Если да, нужно цитировать
а также для клеточных автоматов с увеличенным количеством состояний или иными правилами переходов.

Целью бакалаврской работы являлось исследование возможностей по оптимизации поиска приближенного решения на основе паттернов двумерными клеточными автоматами первого порядка при помощи генетического алгоритма. Для достижения этой цели необходимо было:
\begin{enumerate}
\item разработать гибкое приложение, моделирующее работу клеточных автоматов с возможностью конфигурации генетического алгоритма;
\item добавить визуализацию клеточных автоматов и сбор статистики по экспериментам;
\item провести множество экспериментов с различными конфигурациями и целевыми изображениями;
\item сделать выводы, определить лучшие параметры генетического алгоритма, предложить возможные оптимизации.
\end{enumerate}

\section{Окружение для проведения экспериментов}
В данном разделе приведено описание проекта и вспомогательных функций для моделирования и визуализации двумерных клеточных автоматов первого порядка. 

\subsection{Среда разработки}
Программа для моделирования и визуализации клеточных автоматов выполнена в среде разработки \verb|Unity 2019.2.21f|.

Программный код написан на языке \verb|C#|. Основная логика экспериментов реализована в сцене \foreignlanguage{English}{MainScene}. Весь проект подключен к системе контроля версий %можно сослаться либо на систему контроля версий
Git~\cite{git} на базе популярного ресурса для хранения версий Github.

\subsection{Реализация клеточного автомата}
Каждый клеточный автомат представляется ячейками на двумерной сетке. %упомянуть периодичные граничные условия 
Для прозрачности процесса и наглядности результатов, эксперимент проводится полностью в реальном времени: в каждую единицу времени все ячейки автоматов на всех сетках переходят в новое состояние, определенное входными сигналами и правилами перехода.

Правила перехода описаны для двумерного клеточного автомата первого порядка. При подсчете входного сигнала в ячейке автомата учитываются состояния девяти ячеек в окрестности Мура порядка 2, для подсчета берутся значения с последней итерации. Взят самый простой случай: автомат может принимать значения 0 и 1. Таким образом, возможны $2^9=512$ вариантов входных сигналов.

В качестве визуализации клеточных автоматов в \verb|Unity| использованы шейдеры. Плюс этого подхода заключается в том, что компьютер не будет тратить ресурсы оперативной памяти для визуализации автоматов, и вся нагрузка на это отдается видеокарте, находящейся большую часть времени в простое. Шейдеры позволяют создавать крупные визуализации огромной размерности благодаря эффективным вычислениям на видеокарте~\cite{gpu-performance}. 

\subsubsection{Правило перехода} \label{simple-update}
Была создана простейшая реализация подсчета входных сигналов для ячеек в клеточном автомате. 
Для избежания лишних затрат памяти, в основной части программы заранее созданы массивы для временного хранения следующих состояний ячеек автомата. Это необходимо, чтобы полученный результат не влиял на соседние ячейки в данный момент времени.

\subsubsection{Оптимизированное вычисление входных сигналов} \label{signal-optimized}
В вычислении следующего состояния каждого автомата используется 9 обращений к сетке. Более того, при каждом последующем обращении к сетке после первого, повторно считываются 6 состояний. Квадрат $3\times3$, окрестность Мура порядка 2, может быть представлен в виде окна, которое можно сдвигать вправо по сетке. Разбивая окно на 3 горизонтальные буфер-линии и переходя в новое состояние (аналогично сдвигу окна вправо), будут считываться лишь 3 новых бита справа. Добавление каждого бита в строку-буфер сопровождается побитовым сдвигом строки на 1 влево с отсечением крайнего левого бита. Сигналом для текущего автомата будет сумма верхней строки, средней строки с побитовым сдвигом влево на 3 и нижней строки с побитовым сдвигом на 6.

Результат аналогичен тому, что было получено в предыдущем разделе~\ref{simple-update}, но будет требоваться примерно в 3 раза меньше операций доступа.
% на самом деле это немного не так, но может опустить подробности 

\subsubsection{Правило перехода на языке шейдеров (HLSL)}
Обновление клеточных автоматов было полностью перенесено в шейдеры. Каждая сетка с клеточным автоматом использовует свою текстуру и шейдер (его параметры). В шейдере определена uniform-переменная: таблица переходов размерности 512 (все возможные состояния рассматриваемого клеточного автомата).

Была описана функция, возвращающая значение пикселя с заданным отступом в сетке относительно текущего клеточного автомата. Аналогично построению двоичного числа, последовательно, с левого верхнего угла, биты входных сигналов клеточного автомата в окрестности Мура порядка 2 определяют следующее состояние из таблицы переходов. Данный код выполняется в фрагментном шейдере~\cite{shader-pipeline}.

\section{Генетический алгоритм для поиска клеточных автоматов}
Для получения приближенных результатов, был использован генетический алгоритм~\cite{genetic-algo}. 
\textbf{Особи} "--- сетки с клеточными автоматами, \textbf{гены} "--- правила перехода для клеточных автоматов,
\textbf{приспособленность} особи "--- суммарная по двумерной сетке степень совпадения каждой окрестности ячейки клеточного автомата некоторому целевому изображению (паттерну), 
воспроизведение которого и будет являться целью каждого эксперимента. 

\subsection{Подсчет приспособленности}
Для правильной работы генетического алгоритма необходимо различать <<полезные>> особи от <<ненужных>>. Для этого определим приспособленность особи.
Приспособленностью особи считается как процент совпадения окрестностей клеток на сетке заданному перед началом эксперимента паттерну. 

При подсчете приспособленности учитывается количество допустимых ошибок при сравнении с паттерном. Также учтено, что совпадение может быть найдено не с единственным изображением, а с целым набором.

\subsection{Подсчет приспособленности на основе данных с GPU}
Была предпринята попытка снизить нагрузку во время подсчета приспособленности клеточных автоматов на сетке за счет переноса обновления сетки с процессора на видеокарту. Так как визуализация клеточных автоматов с помощью шейдеров уже готова, достаточно считывать изображение перед каждым подсчетом приспособленности, а после считывания перевести пиксели цвета изображения в числа 0 и 1 и воспользоваться готовой функцией подсчета приспособленности.

Вопреки ожиданиям, это не ускорило программу. Это можно объяснить тем, что скорость передачи данных с видеопамяти в оперативную память крайне медленная~\cite{gpu2cpu}.

\subsection{Оптимизация подсчета приспособленности}
Оптимизация, описанная в разделе~\ref{signal-optimized}, была использована и для подсчета приспособленности. Главное отличие заключается в том, что паттерн может быть произвольного размера. Для начала нужно перевести двоичные числа, образованные последовательным считыванием слева направа каждой строки паттерна в десятичное число и сохранить эту информацию во вспомогательном массиве. Данные числа останутся неизменными. Далее, нужно провести сравнение битов сетки клеточного автомата и паттерна.

Имея два двоичных числа в десятичном представлении, можно получить новое двоичное число, которое будет состоять исключительно из различающихся битов в двух исходных числах. Для быстрого подсчета единиц был использован параллельный SWAR-алгоритм, с которым можно ознакомиться в источнике~\cite{bithacks}. После подсчета разницы, для каждого числа-буфера, полученного для сетки, необходимо сделать побитовый сдвиг влево с выбрасыванием крайнего левого бита (используя бинарное <<И>>) и добавить новое число справа. 

Даже с учетом подобных и ранее описанных оптимизаций в разделе~\ref{signal-optimized}, данный этап остается самым высоко нагруженным. Поэтому для пользователя программы сделана возможность определить количество подсчетов приспособленности на каждом цикле эволюции перед этапом скрещивания.

\subsection{Эволюция}\label{evolution}
Этап эволюции начинается после завершения подсчетов приспособленности клеточных автоматов на последних кадрах. На основании полученных данных будет отбираться половина особей с наивысшей приспособленностью, из них случайным образом будут созданы пары, каждая из которых создаст два потомка. Правила переходов для потомков формируются из генов родителей, которые также сохраняются до следующего этапа эволюции. В работе рассмотрены два вида скрещивания.

После скрещивания случайным образом будут мутируются гены автоматов, полученных после этапа эволюции. В случае клеточных автоматов с возможными состояниями 0 и 1, 0 меняется на 1 и наоборот. Возможны до X мутаций битов в одном автомате, а вероятность того что выбранный клеточный автомат мутирует "--- Y. Оба параметра настраиваются пользователем перед экспериментом.

\subsection{Сбор данных и визуализация эксперимента}
Перед началом эксперимента по поиску клеточного автомата, воспроизводящего паттерн, случайным образом будет создан идентификационный номер (ID) эксперимента. Название сопутствующих файлов со статистикой будет содержать в суффиксе ID эксперимента. Во время исполнения эксперимента, можно наблюдать за графиком приспособленности и генофондом популяции.
% генофонд и график приспособленности

После каждого эксперимента статистика записывается в файлы. Она содержит полную информацию о настройках и результатах (средняя приспособленность, время, количество итераций эволюции) эксперимента, максимальные и средние значения приспособленности на каждой итерации, опорные биты (см. раздел \ref{pivot-bits}). Данные файлы расположены в папке:

\verb|{Расположение_проекта}/Assets/SimulationData/|

После завершения эксперимента, в файл также записываются и правила переходов в виде генов. Файл расположенный в пути:

\verb|{Расположение_проекта}/Assets/SimulationData/Genes/| 

Каждый файл имеет название \verb|G-{Имя_Паттерна}-{IDэксперимента}.txt|. 

В нем ген каждого клеточного автомата записывается в новой строке, и, соответственно, количество строк в файле определяется числом клеточных автоматов в проведенном эксперименте.

Для просмотра клеточных автоматов после эксперимента создана дополнительная сцена в Unity с названием \foreignlanguage{English}{GeneVisualisation}. В основном, она отличается от главной сцены тем, что в ней имеется одна большая сетка размерности $1024\times1024$ и отключена возможность эволюции автоматов. Для считывания файла с генами создан дополнительный скрипт. В редакторе необходимо выбрать автоматически созданный файл с данными генов. Запустив сцену, можно увидеть, как сетка меняет свое изначальное изображение, используя правила перехода из файла.

\section{Эксперименты}
В данном разделе были рассмотрены процессы проведения экспериментов для сбора статистики, с помощью которой в дальнейшем можно выявить зависимость между параметрами эксперимента и скоростью нахождения клеточных автоматов, удовлетворяющих заданным условиям. Перед выполнением экспериментов были поставлены следующие вопросы. Возможно ли найти такие параметры модели, которые для любого паттерна будут приводить к более быстрому нахождению клеточного автомата, моделирующего его? 

Для задания целевых изображений был создан формат текстового файла, позволяющий попиксельно задать паттерны. После каждого эксперимента остается блок сообщений, описывающий полный информацию о результатах эксперимента: время работы, итоговый средний коэффициент приспособленности и другие.

\subsection{Поиск закономерностей в таблице переходов}\label{pivot-bits}
Было сделано предположение, что для любого правила клеточного автомата существуют <<опорные>> биты, являющиеся наиболее важными при формировании определенного паттерна. Было введено вспомогательное определение ценности бита. \textbf{Опорными} считаются те биты, значение ценности по модулю которых превосходит среднее значение (по модулю) ценности среди всех битов правила. Для того чтобы узнать, сохраняются ли опорные биты для повторных попыток найти правила, воспроизводящих заданный паттерн, необходимо найти <<глобальные опорные биты>>. Все биты, глобальное значение ценности которых превышает половину числа подсчетов опорных битов, будут считаться глобальными опорными битами и отображаются на генофонде отдельным (бирюзовым) цветом.

Полученные результаты противоречат предположению. Не найдены зависимости и аналитические способы предугадать диапазон важных для паттерна битов. Все дальнейшие оптимизации нахождения паттерна были проведены за счет выбора <<правильной>> конфигурации эксперимента.

\subsection{Описание проведенных экспериментов}\label{description}
В настоящей работе было проведено 1306 экспериментов над различными паттернами. Каждый паттерн дополняется похожими версиями себя, которые строятся отражением по вертикали или горизонтали исходного целевого изображения или сменой цветов на противоположные (черный на белый и наоборот).

Большая часть паттернов имеет размер $5\times5$. Такой выбор объясняется тем, что клеточные автоматы для паттернов такого размера зачастую ищутся примерно за 300 этапов эволюции, что позволяет провести значительное количество экспериментов за относительно короткий промежуток времени и одновременно заметить разницу между различными параметрами генетического алгоритма. Так как в дальнейшем выводы о наилучшей конфигурации будут браться из статистических данных, необходимо провести большое количество запусков программы.

\section{Анализ экспериментов}
Данный раздел посвящен анализу данных, полученных после проведения экспериментов. Для каждого целевого изображения проводились эксперименты с различными настройками генетического алгоритма: количество клеточных автоматов, вероятность мутации, число мутирующих битов.

\subsection{Обработка и визуализация данных}
Для обработки и визуализации полученных данных создана программа, написанная на языке \verb|Python| с использованием библиотеки \verb|Matplotlib|. Программный код с комментариями написан в среде \verb|Jupyter Notebook|, позволяющей создать наглядный и задокументированный программный код с сохраненным результатом выполнения. Файл в формате \verb|.ipynb| хранится в репозитории. Он расположен в корне папки \verb|Statistics|.

Данный <<ноутбук>> собирает и обрабатывает все файлы со статистикой по выбранному набору файлов.

\subsection{Паттерн-зависимые результаты эксперимента}
Было замечено, что чем больше ошибок допускается при сравнении с целевыми изображениями, тем больше диапазон возможных клеточных автоматов, воспроизводящих заданные паттерны. Тем самым, время поиска любой подходящей комбинации битов в генах снижается. Интересными оказались наблюдения, связанные с паттернами одинакового размера. Было замечено, что среднее время работы таких паттернов может сильно различаться. По полученным данным можно сделать предположение, что на скорость нахождения определенного паттерна влияет форма изображения.

В связи с высокой долей непредсказуемости результатов по разным паттернам, в работе сравниваются друг с другом лишь эксперименты, проведенные над одинаковыми целевыми изображениями. Для минимизации вероятности того, что с определенным паттерном <<повезло>>, были проведены эксперименты с разными параметрами генетического алгоритма над несколькими целевыми изображениями.

\subsection{Оптимальные параметры эксперимента}
Важной составляющей для достижения наиболее быстрого нахождения клеточного автомата, воспроизводящего заданные целевые изображения, является подбор параметров для генетического алгоритма. В бакалаврской работе рассматривались следующие основные параметры генетического алгоритма: процент мутации и максимальное количество бит, которые могут быть мутированы (выбирается случайное число от 1 до максимального).

Для проведения экспериментов были выбраны паттерны, приближенный результат для которых находится меньше чем за 500 итераций (полчаса реального времени). Это позволило провести большое количество экспериментов, тем самым проверив множество комбинаций процента мутации и количества бит. Получены результаты для четырех целевых изображений: <<квадрат $3\times3$ с рамкой 1 пиксель>>, <<елка $5\times5$>>, <<крест $5\times5$>> и <<треугольник $7\times5$ в двух поворотах>>.

По результатам эксперимента были сделаны выводы о параметрах генетического алгоритма, дающих большую приспособленность. Вполне ожидаемо, что низкий процент мутации и мутация одного бита не дает достаточного разнообразия особей. Рассматривая высокие вероятности мутации и количество бит, можно заметить, что конфигурация генетического алгоритма, при которой процент мутации равен 25, а количество бит может достигать 8 или 16, дает наилучшую приспособленность среди всех других рассмотренных конфигураций генетических алгоритмов. Дальнейшее увеличение процента мутаций и количества бит не даст увеличения коэффициента приспособленности. Снижение процента мутации, наоборот, не создает достаточного разнообразия особей.

Данные закономерности прослеживаются для различных паттернов: разной размерности, сложности фигуры, количества допустимых ошибок. Можно быть уверенным, что данные результаты применимы к любому паттерну. Также были приведены результаты для некоторых других паттернов. Они подтверждают сделанные выводы.

В бакалаврской работе приведены дальнейшие возможные исследования.



\newpage
%===========================================
% Раздел "Заключение"
\conclusion
В результате дипломной работы было создано полноценное приложение для нахождения и визуализации двумерных клеточных автоматов первого порядка, воспроизводящих заданное целевое изображение. Данное приложение применимо для проведения экспериментов по подбору наилучших параметров для быстрого и эффективного (по значению приспособленности) поиска заданных клеточных автоматов. С помощью приложения были проведены эксперименты для различных параметров генетического алгоритма. На основе обработанных данных были определены оптимальные параметры генетического алгоритма. Оптимизации также проведены в коде программы, что привело к сокращению времени исполнения алгоритмов в несколько раз.  
Полученные результаты можно использовать и для других клеточных автоматов: высшего порядка, с большим числом состояний, с другим множеством начальных состояний.

%Библиографический список, составленный вручную, без использования BibTeX
%
%\begin{thebibliography}{99}
%  \bibitem{Ione} Источник 1.
%  \bibitem{Itwo} Источник 2
%\end{thebibliography}

%Библиографический список, составленный с помощью BibTeX
%
\bibliographystyle{gost780uv}
\bibliography{thesis}

% Окончание основного документа и начало приложений
% Каждая последующая секция документа будет являться приложением

\end{document}
